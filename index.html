<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Inquiry Portal</title>
</head>
<body style="font-family:Arial, Helvetica, sans-serif; background:#f5f7fa; margin:0; padding:0;">

  <!-- ===== Navigation Bar ===== -->
<nav style="display:flex; justify-content:center; gap:20px; padding:18px; background:#fff; border-bottom:1px solid #ddd; box-shadow:0 2px 6px rgba(0,0,0,0.05);">
  <button 
    onclick="setActiveButton('submitBtn'); showSection('submit');" 
    id="submitBtn"
    style="background:#0066bf; color:#fff; border:none; padding:12px 22px; border-radius:8px; font-weight:600; cursor:pointer; transition:all 0.25s ease; box-shadow:0 2px 4px rgba(0,0,0,0.1);"
    onmouseover="if(this.style.background!=='rgb(0, 102, 191)'){this.style.background='#e0e0e0';}"
    onmouseout="if(this.style.background!=='rgb(0, 102, 191)'){this.style.background='#f4f4f4';}"
  >
    Submit Inquiry
  </button>

  <button 
    onclick="setActiveButton('followBtn'); showSection('followup');" 
    id="followBtn"
    style="background:#f4f4f4; color:#333; border:none; padding:12px 22px; border-radius:8px; font-weight:600; cursor:pointer; transition:all 0.25s ease; box-shadow:0 2px 4px rgba(0,0,0,0.08);"
    onmouseover="if(this.style.background!=='rgb(0, 102, 191)'){this.style.background='#e0e0e0';}"
    onmouseout="if(this.style.background!=='rgb(0, 102, 191)'){this.style.background='#f4f4f4';}"
  >
    Follow Up Inquiry
  </button>
</nav>

  <!-- ===== Header ===== -->
  <header style="
    color:#000;
    text-align:center;
    padding:32px 12px;
    font-family:'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    font-weight:800;
    font-size:32px;
    letter-spacing:1.5px;
    text-transform:uppercase;
    background:transparent;
  ">
    Inquiry Portal
    <div style="
      width:140px;
      height:4px;
      background:linear-gradient(90deg, #0066bf, #00aaff);
      margin:14px auto 0;
      border-radius:2px;
      box-shadow:0 2px 6px rgba(0,102,191,0.4);
    "></div>
  </header>

  <!-- ===== Main Sections ===== -->
  <main style="padding:24px;">
    <!-- === Submit Form Section === -->
    <div id="submitSection">
      <form id="inquiryForm" style="background:#fff; max-width:900px; margin:0 auto; padding:22px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.08);">
        <!-- Student Name -->
        <label style="display:block; font-weight:600; margin-top:12px;">Student Name</label>
        <input id="studentName" name="studentName" required
             style="width:100%; box-sizing:border-box; padding:10px 12px; margin-top:6px; border:1px solid #ccc; border-radius:6px; font-size:14px;" />

        <!-- Student ID -->
        <label style="display:block; font-weight:600; margin-top:12px;">Student University ID</label>
        <input id="studentId" name="studentId" required
              style="width:100%; box-sizing:border-box; padding:10px 12px; margin-top:6px; border:1px solid #ccc; border-radius:6px; font-size:14px;" />

        <!-- Contact number -->
        <label style="display:block; font-weight:600; margin-top:12px;">Student Contact Number</label>
        <input id="contact" name="contact" required
              style="width:100%; box-sizing:border-box; padding:10px 12px; margin-top:6px; border:1px solid #ccc; border-radius:6px; font-size:14px;" />

        <!-- Graduate? -->
        <label style="display:block; font-weight:600; margin-top:12px;">Are you a graduate student in your last semester or with less than 21 credit hours remaining (excluding this semester)?</label>
        <select id="graduate" name="graduate" required
                style="width:100%; padding:10px; margin-top:6px; border:1px solid #ccc; border-radius:6px; font-size:14px;">
          <option value="">Select</option>
          <option value="Yes">Yes</option>
          <option value="No">No</option>
        </select>

        <!-- Registered min 12 hours? -->
        <label style="display:block; font-weight:600; margin-top:12px;">Have you registered minimum 12 hours this semester?</label>
        <select id="registered12" name="registered12" required
                style="width:100%; padding:10px; margin-top:6px; border:1px solid #ccc; border-radius:6px; font-size:14px;">
          <option value="">Select</option>
          <option value="Yes">Yes</option>
          <option value="No">No</option>
        </select>

        <!-- Category -->
        <label style="display:block; font-weight:600; margin-top:12px;">Inquiry Category</label>
        <select id="category" name="category" required onchange="showFollowupQuestions()"
                style="width:100%; padding:10px; margin-top:6px; border:1px solid #ccc; border-radius:6px; font-size:14px;">
          <option value="">Select</option>
          <option value="Adding_Course">Adding Course(s)</option>
          <option value="Section_Change">Change Section</option>
          <option value="Diploma_Program">Associate Diploma Program</option>
          <option value="Exam_Retake">Exam Retake</option>
          <option value="Industrial_Training">Industrial Training</option>
          <option value="Senior_Project">Senior Project</option>
          <option value="NE_Minor">NE Minor Declaration</option>
          <option value="Others">Other Inquiries</option>
        </select>

        <!-- Container for conditional follow-up questions -->
        <div id="extraQuestions" style="margin-top:14px;"></div>

        <!-- Issue details -->
        <div id="issueDetailContainer" style="display:none;">
          <label style="display:block; font-weight:600; margin-top:12px;">Issue Details</label>
          <textarea id="details" name="details" rows="4"
                    style="width:100%;box-sizing:border-box; padding:10px 12px; margin-top:6px; border:1px solid #ccc; border-radius:6px; font-size:14px;"
                    placeholder="Describe your issue..."></textarea>
        </div>

        <!-- Submit -->
        <button type="submit"
                style="background:#0066bf; color:#fff; border:none; padding:10px 18px; border-radius:8px; margin-top:18px; cursor:pointer; font-weight:600;">
          Submit Inquiry
        </button>

        <p id="statusMsg" style="margin-top:12px; font-size:14px;"></p>
      </form>
    </div>

    <!-- === Follow-Up Section === -->
    <div id="followupSection" style="display:none; text-align:center;">
      <div style="background:#fff; max-width:600px; margin:0 auto; padding:30px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.08);">
        <h2 style="font-size:22px; margin-bottom:12px;">Follow Up Inquiry</h2>
        <p>Enter your Student ID to check your inquiry status.</p>
        <input id="followId" type="text" placeholder="Enter Student ID"
              style="width:80%; max-width:400px; padding:10px 12px; border:1px solid #ccc; border-radius:6px; font-size:15px; margin-top:10px;">
        <button onclick="checkStatus()" style="background:#0066bf; color:white; border:none; padding:10px 18px; border-radius:6px; font-weight:600; margin-top:10px; cursor:pointer;">Check Status</button>

        <div id="followupResult" style="margin-top:20px; text-align:left;"></div>
      </div>
    </div>
  </main>

  <script>

  function setActiveButton(activeId) {
    const submitBtn = document.getElementById('submitBtn');
    const followBtn = document.getElementById('followBtn');
  
    // Reset both buttons
    submitBtn.style.background = '#f4f4f4';
    submitBtn.style.color = '#333';
  
    followBtn.style.background = '#f4f4f4';
    followBtn.style.color = '#333';
  
    // Highlight active button
    const activeBtn = document.getElementById(activeId);
    activeBtn.style.background = '#0066bf';
    activeBtn.style.color = '#fff';
  }

  const proxyURL = "https://inquiry-system-five.vercel.app/api/submit";
  const followupURL = "https://script.google.com/macros/s/AKfycbzOq2cn7BsLhRhZfAtvIS7G7zoweRoHRPg5kXtZrQXr5zqWiraRAr2M-B3-Z_4_7qcm/exec";

  /* ===== Switching Form ===== */
  function showSection(section) {
    const submit = document.getElementById('submitSection');
    const follow = document.getElementById('followupSection');
    const sBtn = document.getElementById('submitBtn');
    const fBtn = document.getElementById('followBtn');
    if (section === 'submit') {
      submit.style.display = 'block';
      follow.style.display = 'none';
      sBtn.style.background = '#0066bf';
      sBtn.style.color = 'white';
      fBtn.style.background = '#eaeaea';
      fBtn.style.color = '#333';
    } else {
      submit.style.display = 'none';
      follow.style.display = 'block';
      fBtn.style.background = '#0066bf';
      fBtn.style.color = 'white';
      sBtn.style.background = '#eaeaea';
      sBtn.style.color = '#333';
    }
  }

  // ===== Submit Follow-up Request =====
  async function checkStatus() {
    const id = document.getElementById('followId').value.trim();
    const followup_response_container = document.getElementById('followupResult');
    followup_response_container.innerHTML = '';

    if (!id) {
      followup_response_container.innerHTML = '<p style="color:red;">Please enter your Student ID.</p>';
      return;
    }

  // Show loading indicator
  followup_response_container.innerHTML = '<p style="color:#0066bf; font-weight:600;">Fetching data, please wait...</p>';

    try {
      const res = await fetch(followupURL + "?id=" + encodeURIComponent(id));
      const data = await res.json();

      if (!data || data.length === 0) {
        followup_response_container.innerHTML = '<p style="color:#d32f2f; font-weight:600;">No inquiries found for this ID.</p>';
        return;
      }

      let html = '<h3>Your Inquiries:</h3>';
      data.forEach((d, i) => {
        const now = new Date();
        const submitted = new Date(d.timestamp);
        const diffMs = now - submitted; // difference in milliseconds
        const diffMins = Math.floor(diffMs / 60000);
        
        let displayTime;
        if (diffMins < 1) displayTime = "Just now";
        else if (diffMins < 60) displayTime = `${diffMins} min ago`;
        else if (diffMins < 1440) displayTime = `${Math.floor(diffMins/60)} hours ago`;
        else displayTime = submitted.toLocaleString('en-GB', { 
            day: '2-digit', month: '2-digit', year: 'numeric',
            hour: '2-digit', minute: '2-digit', second: '2-digit',
            hour12: true
          });

        html += `
          <div style="border:1px solid #ccc; border-radius:6px; padding:10px; margin-top:10px;">
            <p><strong>Inquiry #${i + 1}</strong></p>
            <p><strong>Inquiry Submitted Date:</strong> ${displayTime}</p>
            <p><strong>Category:</strong> ${d.category}</p>
            <p><strong>Request Status:</strong> <span style="color:${d.status === 'Pending' ? 'orange' : 'green'}">${d.status}</span></p>
          </div>
        `;
      });
      followup_response_container.innerHTML = html;

    } catch (err) {
      console.error(err);
      followup_response_container.innerHTML = '<p style="color:red;">Error fetching data. Please try again later.</p>';
    }
  }

  // ===== FOLLOW-UP QUESTIONS LOGIC =====
  let courseCount = 1;

  // ===== Handel "Issue Details" Visibility =====
  function toggleIssueDetails(show) {
    const issueContainer = document.getElementById('issueDetailContainer');
    issueContainer.style.display = show ? 'block' : 'none';
  }

  function showFollowupQuestions() {
    const category = document.getElementById('category').value;
    const container = document.getElementById('extraQuestions');
  const submitBtn = document.querySelector('#inquiryForm button[type="submit"]');

  container.innerHTML = '';
  toggleIssueDetails(false);

  if (submitBtn) {
    submitBtn.disabled = false;
    submitBtn.style.background = '#0066bf';
    submitBtn.style.color = '#fff';
  }
    
    const labelStyle = 'display:block; font-weight:600; margin-top:12px;';
    const inputStyle = 'width:100%; box-sizing:border-box; padding:10px 12px; margin-top:6px; border:1px solid #ccc; border-radius:6px; font-size:14px;';

    if (category === 'Adding_Course') {
      container.innerHTML = `
        <label style="${labelStyle}">Have you added the course to the waiting list?</label>
        <select id="q1" data-label="Added to waiting list?" required  style="${inputStyle}">
          <option value="" selected disabled>Select</option>
          <option>Yes</option>
          <option>No</option>
        </select>

        <label style="${labelStyle}">Course ID</label>
        <input type="text" id="q2" data-label="Course ID" required  style="${inputStyle}">

        <label style="${labelStyle}">Section Requested</label>
        <input type="text" id="q3" data-label="Section Requested" required style="${inputStyle}">
      `;
    } else if (category === 'Section_Change') {
      container.innerHTML = `
        <label style="${labelStyle}">Course ID</label>
        <input type="text" id="q1" data-label="Course ID" required style="${inputStyle}">

        <label style="${labelStyle}">Current Section</label>
        <input type="text" id="q2" data-label="Current Section" required style="${inputStyle}">

        <label style="${labelStyle}">Requested Section</label>
        <input type="text" id="q3" data-label="Requested Section" required style="${inputStyle}">

        <label style="${labelStyle}">Reason for Section Change</label>
         <select id="q4" data-label="Reason for section change:" required style="${inputStyle}">
          <option value="" selected disabled>Select</option>
          <option value="addAnotherCourse">Need to Register Another Course</option>
          <option value="longBreak">Break of 6 hours or more</option>
        </select>

        <div id="OtherCourseDetails"></div>
        
        <label style="${labelStyle}">Upload your schedule (image only)</label>
        <input type="file" id="scheduleUpload" name="scheduleUpload" accept="image/*" required style="${inputStyle}">
      `;
      handleSectionChangeReason(labelStyle, inputStyle);
    } else if (category === 'Diploma_Program') {
      container.innerHTML = `
        <label style="${labelStyle}">Is your advisor listed in SIS?</label>
        <select id="q1" data-label="Advisor appears in SIS?" required style="${inputStyle}">
          <option value="" selected disabled>Select</option>
          <option>Yes</option>
          <option>No</option>
        </select>

        <label style="${labelStyle}">Main Issue</label>
        <select id="q2" data-label="Main Issue" required style="${inputStyle}" onchange="showDiplomaSubQuestions()">
          <option value="">Select</option>
          <option value="courses_equivalence">Course(s) equivalence</option>
          <option value="advisor_not_shown">Don't have an advisor</option>
          <option value="Need_AD_Program">Need the "Associate Diploma in Information Technology" Program</option>
          <option value="other_issue">Others</option>
        </select>

        <div id="diplomaExtra"></div>
      `;
    } else if (category === 'Exam_Retake') {
      container.innerHTML = `
        <label style="${labelStyle}">Have you filled the "Final Exam Absence" form?</label>
        <select id="q1" data-label="Filled Exam Retake Form?" required style="${inputStyle}">
          <option value="">Select</option>
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>
       
       <div id="ExamAbsenceFormNotFilled" style="margin-top:10px;"></div>
      `;
      handleExamFormChange(labelStyle, inputStyle);
    } else if (category === 'Industrial_Training') {
      container.innerHTML = `
        <label style="${labelStyle}">Main Issue</label>
        <select id="q1" data-label="Main Issue" required style="${inputStyle}">
          <option value="" selected disabled>Select</option>
          <option value="need_training_grade">Need Industrial Training Grade</option>
          <option value="loocking_for_training_place">Need place for Industrial Training</option>
          <option value="need_training_letter">Need Industrial Training Letter</option>
          <option value="other_issue">Others</option>
        </select>
      `;
      showOthersForIndustrialTraining(labelStyle, inputStyle);
    } else if (category === 'Senior_Project') {
      container.innerHTML = `
        <div style="margin-top:12px;">
          <p style="font-weight:600; color:#0066bf;">Kindly visit the Senior Project Coordinator.</p>
          <p style="font-size:14px; color:#0066bf; margin:6px 0 25px 0;">
            If the Head of Department was your supervisor, send an email or visit the department after registration week.
          </p>
        </div>
      `;
      toggleIssueDetails(true);
        } else if (category === 'NE_Minor') {
      container.innerHTML = `
        <label style="${labelStyle}">Is your minor Declared?</label>
        <select id="q1" data-label="NE Declared?" required style="${inputStyle}">
          <option value="" selected disabled>Select</option>
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>
        <div id="minorExtra" style="margin-top:12px;"></div>
      `;
      handleNEMinorChange(labelStyle, inputStyle);
        } else if (category === 'Others') {
            toggleIssueDetails(true);
    }
  }

function handleNEMinorChange(labelStyle, inputStyle) {
  const minorSelect = document.getElementById('q1');
  const minorExtra = document.getElementById('minorExtra');
  const submitBtn = document.querySelector('#inquiryForm button[type="submit"]');

  if (!minorSelect || !minorExtra || !submitBtn) return;

  minorSelect.addEventListener('change', function () {
    if (this.value === 'yes') {
      toggleIssueDetails(true);
      minorExtra.innerHTML = '';
      submitBtn.disabled = false;
      submitBtn.style.background = '#0066bf';
      submitBtn.style.color = '#fff';
    } else if (this.value === 'no') {
      toggleIssueDetails(false);
      minorExtra.innerHTML = `
        <p style="color:#d32f2f; font-weight:600;">
          Please submit a minor declaration through SIS.
        </p>
      `;
      submitBtn.disabled = true;
      submitBtn.style.background = '#aaa';
      submitBtn.style.color = '#666';
    } else {
      minorExtra.innerHTML = '';
      submitBtn.disabled = false;
      submitBtn.style.background = '#0066bf';
      submitBtn.style.color = '#fff';
    }
  });
}

function handleExamFormChange(labelStyle, inputStyle) {
  const examFormStatus = document.getElementById('q1');
  const examExtraFields = document.getElementById('ExamAbsenceFormNotFilled');
  const submitBtn = document.querySelector('#inquiryForm button[type="submit"]');

  if (!examFormStatus || !examExtraFields || !submitBtn) return;

  examFormStatus.addEventListener('change', function () {
    if (this.value === 'yes') {
      examExtraFields.innerHTML = `
        <p style="color:#d32f2f; font-weight:600;">
          Please contact the Head of Department via Email if you haven't received approval yet.
        </p>
      `;
      submitBtn.disabled = true;
      submitBtn.style.background = '#aaa';
      submitBtn.style.color = '#666';
    } else if (this.value === 'no') {
      examExtraFields.innerHTML = `
        <label style="${labelStyle}">Course ID</label>
        <input type="text" id="q2" data-label="Course ID" required style="${inputStyle}">

        <label style="${labelStyle}">Section Number</label>
        <input type="text" id="q3" data-label="Section Number" required style="${inputStyle}">

        <label style="${labelStyle}">Course Exam Date</label>
        <input type="text" id="q4" data-label="Exam Date" required style="${inputStyle}">

        <label style="${labelStyle}">Instructor Name</label>
        <input type="text" id="q5" data-label="Instructor Name" required style="${inputStyle}">

        <label style="${labelStyle}">Briefly explain your excuse</label>
        <input type="text" id="q6" data-label="Explain Excuse" required style="${inputStyle}">

        <label style="${labelStyle}">Upload your excuse (PDF only)</label>
        <input type="file" id="excuseUpload" name="excuseUpload" accept="application/pdf" required style="${inputStyle}">
      `;
      submitBtn.disabled = false;
      submitBtn.style.background = '#0066bf';
      submitBtn.style.color = '#fff';
    } else {
      examExtraFields.innerHTML = '';
      submitBtn.disabled = false;
      submitBtn.style.background = '#0066bf';
      submitBtn.style.color = '#fff';
    }
  });
}

    function handleSectionChangeReason(labelStyle, inputStyle) {
      const reasonSelect = document.getElementById('q4');
      const extraFields = document.getElementById('OtherCourseDetails');
    
      if (!reasonSelect || !extraFields) return;
    
      reasonSelect.addEventListener('change', function () {
        if (this.value === 'addAnotherCourse') {
          extraFields.innerHTML = `
            <label style="${labelStyle}">Enter the other Course ID </label>
            <input type="text" id="q5" data-label="Other Course ID" required style="${inputStyle}">
    
            <label style="${labelStyle}">Enter the section number of that course</label>
            <input type="text" id="q6" data-label="Other Course Section" required style="${inputStyle}">
          `;
        } else {
          extraFields.innerHTML = '';
        }
      });
    }

function showDiplomaSubQuestions() {
  const issue = document.getElementById('q2').value;
  const diplomaExtra = document.getElementById('diplomaExtra');
  const labelStyle = 'display:block; font-weight:600; margin-top:12px;';
  const inputStyle = 'width:100%; box-sizing:border-box; padding:10px 12px; margin-top:6px; border:1px solid #ccc; border-radius:6px; font-size:14px;';

  const submitBtn = document.querySelector('#inquiryForm button[type="submit"]');
  toggleIssueDetails(false);

  if (issue === 'courses_equivalence') {
    diplomaExtra.innerHTML = `
      <p style="color:#d32f2f; font-weight:600;">
        Visit your Academic Advisor and request them to send a letter to the Head of Department with the courses that are equivalent.
      </p>
    `;
      submitBtn.disabled = true;
      submitBtn.style.background = '#aaa';
      submitBtn.style.color = '#666';
  } 
  else if (issue === 'other_issue') {
    toggleIssueDetails(true);
    diplomaExtra.innerHTML = '';
    submitBtn.disabled = false;
    submitBtn.style.background = '#0066bf';
    submitBtn.style.color = '#fff';  } 
  else {
      diplomaExtra.innerHTML = '';
      submitBtn.disabled = false;
      submitBtn.style.background = '#0066bf';
      submitBtn.style.color = '#fff';
  }
}


function showOthersForIndustrialTraining(labelStyle, inputStyle) {
  const issueDetails = document.getElementById('q1');
  issueDetails.addEventListener('change', function () {
    if (this.value === 'other_issue') {
      toggleIssueDetails(true);
    } else {
      toggleIssueDetails(false);
    }
  });
}

function collectFormData() {
  const data = {
    studentName: document.getElementById('studentName').value.trim(),
    studentId: document.getElementById('studentId').value.trim(),
    contact: document.getElementById('contact').value.trim(),
    graduate: document.getElementById('graduate').value,
    registered12: document.getElementById('registered12').value,
    category: document.getElementById('category').value,
    details: document.getElementById('details').value.trim(),
    extra: {},
    files: [] 
  };

  const extraInputs = document.querySelectorAll('#extraQuestions input, #extraQuestions select, #extraQuestions textarea');
  extraInputs.forEach(el => {
    const label = el.getAttribute('data-label') || el.id;
    data.extra[label] = el.value.trim();
  });

  const scheduleFile = document.getElementById('scheduleUpload');
  if (scheduleFile && scheduleFile.files.length > 0) {
    const file = scheduleFile.files[0];
    data.files.push({
      name: file.name,
      mimeType: file.type,
      content: null 
    });
  }

  const excuseFile = document.getElementById('excuseUpload');
  if (excuseFile && excuseFile.files.length > 0) {
    const file = excuseFile.files[0];
    data.files.push({
      name: file.name,
      mimeType: file.type,
      content: null
    });
  }

  return data;
}

// Submit handler remains the same
document.getElementById('inquiryForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const status = document.getElementById('statusMsg');
  status.style.color = '#333';
  status.innerText = 'Submitting...';
  try {
    const res = await fetch(proxyURL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(collectFormData())
    });
    const json = await res.json();
    if (json.success) {
      status.style.color = 'green';
      status.innerText = 'Inquiry submitted successfully!';
      document.getElementById('inquiryForm').reset();
      document.getElementById('extraQuestions').innerHTML = '';
    } else {
      status.style.color = 'red';
      status.innerText = 'Submission failed. Try again later.';
    }
  } catch (err) {
    console.error(err);
    status.style.color = 'red';
    status.innerText = 'Error submitting form. Check console.';
  }
});
  </script>
</body>
</html>
